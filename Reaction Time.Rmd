---
title: "Reaction Time"
author: "Benjamin Holding"
date: 'Last Updated: `r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
ipak <- function(pkg){
    new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
    if (length(new.pkg)) 
        install.packages(new.pkg, dependencies = TRUE)
    sapply(pkg, require, character.only = TRUE)
} #function to see if package is installed. Will download if not, and then opens it.

packages <- c("data.table", "lubridate", "anytime", "dplyr", "ggplot2", "nlme", "tidyr", "nlme") #These are the extra packages needed to merge the CSV files
suppressPackageStartupMessages(ipak(packages))
```


```{r, include=FALSE}

myoriginalwd <- getwd()
setwd("Slesi_reaction_time_renamed") #enter the location of the data here between quotation marks
file_list <- list.files()
L <- length(file_list) 

Q_list <- lapply(file_list, read.csv, header=T, sep=",", dec=".")

setwd(myoriginalwd)
RT.names <- read.csv("Reaction_time_file_names.csv", header = F)

names(Q_list) <- RT.names[,1]

final.list <- mapply(cbind, Q_list, "SampleID"=RT.names[,1], SIMPLIFY=F)

Questionnaires_KSS <- rbindlist(final.list, fill = T) #this is the complete data frame
Questionnaires_KSS$id <- as.character(Questionnaires_KSS$id)
Questionnaires_KSS$id[which(Questionnaires_KSS$id == "SI_106_2")] <- "SI_106"
Questionnaires_KSS$id[which(Questionnaires_KSS$id == "SI_106_3")] <- "SI_106"
Questionnaires_KSS$id[which(Questionnaires_KSS$id == "SI_106_4")] <- "SI_106"

Questionnaires_KSS$id <- as.numeric(gsub("[^0-9]","",Questionnaires_KSS$id))
colnames(Questionnaires_KSS)[1] <- "ID"

slesi.key <- read.csv("SleSI_Masterkey.csv")

Questionnaires_KSS_complete <- inner_join(Questionnaires_KSS, slesi.key)

Questionnaires_KSS_complete$SampleID <- gsub("RT_", "", Questionnaires_KSS_complete$SampleID)
Questionnaires_KSS_complete$SampleID <- gsub(".csv", "", Questionnaires_KSS_complete$SampleID)

KSS_Complete_TIDY <- Questionnaires_KSS_complete[c(-1,-2,-3)] %>% 
  separate(SampleID, into = c("ID", "time"), sep = "\\_")
                             
KSS_Complete_TIDY$time <- as.integer(KSS_Complete_TIDY$time)

```

#removing problem answers
(only between 100-4000milliseconds)
```{r}
KSS_Complete_TIDY <- KSS_Complete_TIDY[which(KSS_Complete_TIDY$reaction_time > 100 & KSS_Complete_TIDY$reaction_time < 4000),]
```

# Assessing the best growth curve model

### Should I add a random intercept? - yes 
```{r}
model.1<-gls(reaction_time~1, data=KSS_Complete_TIDY, na.action=na.omit)
summary(model.1)

model.2<-lme(reaction_time~1, random=~1|ID, data=KSS_Complete_TIDY, na.action=na.omit)
anova(model.1,model.2) #model with random effects is significantly better
summary(model.2)

VarCorr(model.2)
10122.76/(10122.76+31280.16) #25% of variance can be attributed to variance in RT between individuals
```

### Should I have a time polynomial effect? - yes (cubic)
```{r}
# assessing the best time polynomial
model.3a<-lme(reaction_time~1, random=~1|ID, data=KSS_Complete_TIDY, na.action=na.omit, method="ML")
# model.3b<-lme(reaction_time~time, random=~1|ID, data=KSS_Complete_TIDY, na.action=na.omit, method="ML") # DOESN'T CONVERGE
model.3c<-lme(reaction_time~time+I(time^2), random=~1|ID, data=KSS_Complete_TIDY, na.action=na.omit, method="ML")
model.3d<-lme(reaction_time~time+I(time^2)+I(time^3), random=~1|ID, data=KSS_Complete_TIDY, na.action=na.omit, method="ML") 

anova(model.3a, model.3c, model.3d) #the cubic model is the best

summary(model.3d)
```


### Should I add random slopes? - Yes (random slopes up to quadratic effect)
```{r}
# assessing the best random effects term
model.4a<-lme(reaction_time~time+I(time^2)+I(time^3), random=~1|ID, data=KSS_Complete_TIDY, na.action=na.omit, method="REML") 

model.4b<-lme(reaction_time~time+I(time^2)+I(time^3), random=~time|ID, data=KSS_Complete_TIDY, na.action=na.omit, method="REML") 

model.4c<-lme(reaction_time~time+I(time^2)+I(time^3), random=~time+I(time^2)|ID, data=KSS_Complete_TIDY, na.action=na.omit, method="REML") 

# model.4d<-lme(reaction_time~time+I(time^2)+I(time^3), random=~time+I(time^2)+I(time^3)|ID, data=KSS_Complete_TIDY, na.action=na.omit, method="REML") #doesn't converge

anova(model.4a,model.4b,model.4c) #having random slopes for quadratic term for time is best
```

### adding the sleep condition as a predictor
```{r}
#additing in variables can that explain intercept and slope variability
model.6a<-lme(reaction_time~time+I(time^2)+I(time^3), random=~time+I(time^2)|ID, data=KSS_Complete_TIDY, na.action=na.omit, method="ML") 
model.6b<-lme(reaction_time~time+I(time^2)+I(time^3)+SD, random=~time+I(time^2)|ID, data=KSS_Complete_TIDY, na.action=na.omit, method="ML") 

anova(model.6a,model.6b)#condition doesn't predict intercept, which is good because there should be no difference

model.6c <-lme(reaction_time~time*SD+I(time^2)+I(time^3), random=~time+I(time^2)|ID, data=KSS_Complete_TIDY, na.action=na.omit, method="ML") 

anova(model.6a,model.6c) #sleep deprivation explains variance in slope of time (linear)

model.6d <-lme(reaction_time~time*SD+I(time^2)*SD+I(time^3), random=~time+I(time^2)|ID, data=KSS_Complete_TIDY, na.action=na.omit, method="ML") #sleep deprivation explains variance in the slope of time (quadratic)
anova(model.6a,model.6d)

model.6e <-lme(reaction_time~time*SD+I(time^2)*SD+I(time^3)*SD, random=~time+I(time^2)|ID, data=KSS_Complete_TIDY, na.action=na.omit, method="ML") #sleep deprivation explains variance in the slope of time (quadratic)
anova(model.6a,model.6e) #sleep deprivation explains variance in the slope of time (cubic)
```

#The best fitting growth curve model
There is an interaction between the condition and linear effect of time, the quadratic effect of time and the cubic effect of time.
The p value for tells you whether the difference in the curvature for the two condition is statistically significant. 
```{r}
summary(model.6e)
```


#plotting the final model
```{r}
KSS_Complete_TIDY$SD <- as.factor(KSS_Complete_TIDY$SD)
RT.final.model <-lme(reaction_time~time*SD+I(time^2)*SD+I(time^3)*SD, random=~time+I(time^2)|ID, data=KSS_Complete_TIDY, na.action=na.omit, method="ML")

#raw data plot with 95% confidence intervals
ggplot(KSS_Complete_TIDY, aes(time, reaction_time, colour=SD)) + 
  stat_summary(fun.data=mean_cl_normal, fun.args=list(conf.int=0.95), geom="pointrange") + 
  labs(y="Reaction Time (ms)", x="Time point") + 
  theme_bw() + scale_color_manual(values=c("red", "blue")) +
  ggtitle("RT raw data plot with 95% confidence intervals") + stat_summary(fun.y=mean, geom="line")

#fitted model (aka predictive values) plot with 95% confidence intervals
ggplot(KSS_Complete_TIDY, aes(time, reaction_time, colour=SD)) + 
  labs(y="Reaction Time (ms)", x="Time point") +
  ggtitle("RT model fitted (predicted) data plot with 95% confidence intervals") + 
  theme_bw() + stat_summary(aes(y=fitted(RT.final.model)), fun.data=mean_cl_normal, fun.args=list(conf.int=0.95), geom="pointrange") + stat_smooth(method = "lm", formula  =y ~ poly(x,3))
```


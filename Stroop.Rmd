---
title: "Stroop"
author: "Benjamin Holding"
date: 'Last Updated: `r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE)
```

```{r packages, include=FALSE}
ipak <- function(pkg){
    new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
    if (length(new.pkg)) 
        install.packages(new.pkg, dependencies = TRUE)
    sapply(pkg, require, character.only = TRUE)
} #function to see if package is installed. Will download if not, and then opens it.

packages <- c("data.table", "lubridate", "anytime", "dplyr", "ggplot2", "nlme", "tidyr", "lme4", "lmerTest") #These are the extra packages needed to merge the CSV files
suppressPackageStartupMessages(ipak(packages))
```

```{r data, include=FALSE}

myoriginalwd <- getwd()
setwd("Stroop") #enter the location of the data here between quotation marks
file_list <- list.files()
L <- length(file_list) 

Stroop_list <- lapply(file_list, read.csv, header=T, sep=",", dec=".")

setwd(myoriginalwd)
Stroop.names <- read.csv("Stroop_filenames.csv", header = F)

names(Stroop_list) <- Stroop.names[,1]

final.list <- mapply(cbind, Stroop_list, "SampleID"=Stroop.names[,1], SIMPLIFY=F)

WakeApp_Stroop <- rbindlist(final.list, fill = T) #this is the complete data frame
WakeApp_Stroop$id <- as.character(WakeApp_Stroop$id)
WakeApp_Stroop$id[which(WakeApp_Stroop$id == "SI_106_2")] <- "SI_106"
WakeApp_Stroop$id[which(WakeApp_Stroop$id == "SI_106_3")] <- "SI_106"
WakeApp_Stroop$id[which(WakeApp_Stroop$id == "SI_106_4")] <- "SI_106"

WakeApp_Stroop$id <- as.numeric(gsub("[^0-9]","",WakeApp_Stroop$id))
colnames(WakeApp_Stroop)[1] <- "ID"

slesi.key <- read.csv("SleSI_Masterkey.csv")

WakeApp_Stroop_complete <- inner_join(WakeApp_Stroop, slesi.key)

WakeApp_Stroop_complete$SampleID <- gsub("STROOP_", "", WakeApp_Stroop_complete$SampleID)
WakeApp_Stroop_complete$SampleID <- gsub(".csv", "", WakeApp_Stroop_complete$SampleID)
sample_n(WakeApp_Stroop_complete[,c(1,18,15)], 10) #check that everything is matched correctely

Stroop_Complete_TIDY <- WakeApp_Stroop_complete[c(-1,-2,-3)] %>% 
  separate(SampleID, into = c("ID", "time"), sep = "\\_")
                             
Stroop_Complete_TIDY$time <- as.integer(Stroop_Complete_TIDY$time)

```

##remove problem responses
(must respond between 0.1 and 10 seconds)
```{r time}
Stroop_Complete_TIDY <- Stroop_Complete_TIDY[which(Stroop_Complete_TIDY$reaction_time > 100 & Stroop_Complete_TIDY$reaction_time < 10000),]
```

# Stroop correct responses
###Finding the best growth curve model
```{r growth curve all}

# assessing the best time polynomial
model.3a<-glmer(correct~1 + (1|ID), data=Stroop_Complete_TIDY, family=binomial)
model.3b<-glmer(correct~time + (1|ID), data=Stroop_Complete_TIDY, family=binomial)
model.3c<-glmer(correct~ time + I(time^2) + (1|ID), data=Stroop_Complete_TIDY, family=binomial)
model.3d<-glmer(correct~ time + I(time^2) + I(time^3) + (1|ID), data=Stroop_Complete_TIDY, family=binomial) #definately best but convergence problems

anova(model.3a, model.3b, model.3c,model.3d) #the cubic  model is the best

#summary(model.3d)

# not going to add random slopes since convergence is already poor

# how does congruence fit in

model.5a <- glmer(correct~ time + I(time^2) + I(time^3) + (1|ID), data=Stroop_Complete_TIDY, family=binomial)
model.5b <- glmer(correct~ congruent + time + I(time^2) + I(time^3) + (1|ID), data=Stroop_Complete_TIDY, family=binomial)
model.5c <- glmer(correct~ congruent*time + I(time^2) + I(time^3) + (1|ID), data=Stroop_Complete_TIDY, family=binomial) #best
model.5d <- glmer(correct~ congruent*time + congruent*I(time^2) + I(time^3) + (1|ID), data=Stroop_Complete_TIDY, family=binomial)
model.5e <- glmer(correct~ congruent*time + congruent*I(time^2) + congruent*I(time^3) + (1|ID), data=Stroop_Complete_TIDY, family=binomial)

anova(model.5a, model.5b, model.5c,model.5d, model.5e)
#does how does SD fit in?

model.6a<- glmer(correct~ congruent*time + I(time^2) + I(time^3) + (1|ID), data=Stroop_Complete_TIDY, family=binomial)
model.6b<- glmer(correct~ congruent*time + SD + I(time^2) + I(time^3) + (1|ID), data=Stroop_Complete_TIDY, family=binomial)
model.6c <- glmer(correct~ congruent*time*SD + I(time^2) + I(time^3) + (1|ID), data=Stroop_Complete_TIDY, family=binomial)
model.6d <- glmer(correct~ congruent*time*SD + SD*I(time^2) + I(time^3) + (1|ID), data=Stroop_Complete_TIDY, family=binomial) #best
model.6e <- glmer(correct~ congruent*time*SD + SD*I(time^2) + SD*I(time^3) + (1|ID), data=Stroop_Complete_TIDY, family=binomial)

anova(model.6a,model.6b, model.6c,model.6d,model.6e)

```

###Best model for correct Stroop responses
predicts score from congruency, time, time2, time3, SD, congruency:time, congruency:SD, SD:time2
```{r}
#best model
summary(model.6d)
```


###plotting the raw data and final model
```{r}
Stroop_Complete_TIDY$SD <- as.factor(Stroop_Complete_TIDY$SD)
Stroop_Complete_TIDY$congruent <- as.factor(Stroop_Complete_TIDY$congruent)
levels(Stroop_Complete_TIDY$congruent) <- c("Incongruent", "Congruent")


Stroop.final.model <- model.6d

ggplot(Stroop_Complete_TIDY, aes(time, correct, colour=SD)) + 
  stat_summary(fun.data=mean_cl_normal, fun.args=list(conf.int=0.95), geom="pointrange")  + 
  labs(y="correct", x="Time point") + 
  facet_wrap( ~ congruent) +
  ggtitle("Stroop raw data plot (accuracy) with 95% confidence intervals") +
  theme_bw() + scale_color_manual(values=c("red", "blue")) + stat_summary(fun.y=mean, geom="line") 

ggplot(model.6d, aes(time, correct, colour=SD)) + 
  labs(y="Stroop (correct score)", x="Time point") +
    ggtitle("Stroop fitted model data plot (accuracy)") +
  theme_bw() + stat_summary(aes(y=fitted(model.6d)), fun.data=mean_cl_normal, fun.args=list(conf.int=0.95), geom="pointrange") + stat_smooth(method = "lm", formula  =y ~ poly(x,3)) 
```

#Stroop reaction time (for correct responses)
###Finding best growth curve model
```{r}
Stroop_complete_correct <- Stroop_Complete_TIDY[which(Stroop_Complete_TIDY$correct == 1),]

# assessing the best time polynomial
model.3a<-lme(reaction_time~1, random=~1|ID, data=Stroop_complete_correct, na.action=na.omit, method="ML")
model.3b<-lme(reaction_time~time, random=~1|ID, data=Stroop_complete_correct, na.action=na.omit, method="ML")
model.3c<-lme(reaction_time~time+I(time^2), random=~1|ID, data=Stroop_complete_correct, na.action=na.omit, method="ML")
model.3d<-lme(reaction_time~time+I(time^2)+I(time^3), random=~1|ID, data=Stroop_complete_correct, na.action=na.omit, method="ML") 

anova(model.3a, model.3b, model.3c, model.3d) #the cubic model is the best

summary(model.3d)

# assessing the best random effects term
model.4a<-lme(reaction_time~time+I(time^2)+I(time^3), random=~1|ID, data=Stroop_complete_correct, na.action=na.omit, method="ML") 
model.4b<-lme(reaction_time~time+I(time^2)+I(time^3), random=~time|ID, data=Stroop_complete_correct, na.action=na.omit, method="ML") #best
model.4c<-lme(reaction_time~time+I(time^2)+I(time^3), random=~time+I(time^2)|ID, data=Stroop_complete_correct, na.action=na.omit, method="ML")
#model.4d<-lme(reaction_time~time+I(time^2)+I(time^3), random=~time+I(time^2)+I(time^3)|ID, data=Stroop_complete_correct, na.action=na.omit, method="ML") #convergence problem

anova(model.4a,model.4b, model.4c) #having random slopes for quadratic term for time is best

#Adding congruence
model.5a<-lme(reaction_time~time+I(time^2)+I(time^3), random=~time+I(time^2)|ID, data=Stroop_complete_correct, na.action=na.omit, method="ML")
model.5b<-lme(reaction_time~time+congruent+I(time^2)+I(time^3), random=~time+I(time^2)|ID, data=Stroop_complete_correct, na.action=na.omit, method="ML") #best
model.5c<-lme(reaction_time~time*congruent+I(time^2)+I(time^3), random=~time+I(time^2)|ID, data=Stroop_complete_correct, na.action=na.omit, method="ML")
model.5d<-lme(reaction_time~time*congruent+congruent*I(time^2)+I(time^3), random=~time+I(time^2)|ID, data=Stroop_complete_correct, na.action=na.omit, method="ML")
model.5e<-lme(reaction_time~time*congruent+congruent*I(time^2)+congruent*I(time^3), random=~time+I(time^2)|ID, data=Stroop_complete_correct, na.action=na.omit, method="ML")

anova(model.5a,model.5b, model.5c, model.5d, model.5e) 

#adding sleep condition
model.6a<-lme(reaction_time~time+congruent+I(time^2)+I(time^3), random=~time+I(time^2)|ID, data=Stroop_complete_correct, na.action=na.omit, method="ML")
model.6b<-lme(reaction_time~time+SD+congruent+I(time^2)+I(time^3), random=~time+I(time^2)|ID, data=Stroop_complete_correct, na.action=na.omit, method="ML") 
#model.6c<-lme(reaction_time~time*SD+congruent+I(time^2)+I(time^3), random=~time+I(time^2)|ID, data=Stroop_complete_correct, na.action=na.omit, method="ML") #convegence problem
model.6d<-lme(reaction_time~time*SD+congruent+SD*I(time^2)+I(time^3), random=~time+I(time^2)|ID, data=Stroop_complete_correct, na.action=na.omit, method="ML")
model.6e<-lme(reaction_time~time*SD+congruent+SD*I(time^2)+SD*I(time^3), random=~time+I(time^2)|ID, data=Stroop_complete_correct, na.action=na.omit, method="ML") #best
model.6f<-lme(reaction_time~time*SD*congruent+SD*I(time^2)+SD*I(time^3), random=~time+I(time^2)|ID, data=Stroop_complete_correct, na.action=na.omit, method="ML") 
anova(model.6a,model.6b,model.6d,model.6e,model.6f)
```

###best model (correct answers only)
```{r}
summary(model.6e)
```

### plotting raw data and model
```{r}
Stroop.final.model <- model.6e

ggplot(Stroop_complete_correct, aes(time, reaction_time, colour=SD)) + 
  stat_summary(fun.data=mean_cl_normal, fun.args=list(conf.int=0.95), geom="pointrange")  + 
  labs(y="correct", x="Time point") + 
  facet_wrap( ~ congruent) +
  theme_bw() + scale_color_manual(values=c("red", "blue")) + stat_summary(fun.y=mean, geom="line") 

ggplot(Stroop_complete_correct, aes(time, reaction_time, colour=SD)) + 
  labs(y="Stroop (correct score)", x="Time point") +
  theme_bw() + stat_summary(aes(y=fitted(Stroop.final.model)), fun.data=mean_cl_normal, fun.args=list(conf.int=0.95), geom="pointrange") + stat_smooth(method = "lm", formula  =y ~ poly(x,3)) 
```

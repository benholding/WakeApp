---
title: "Stroop"
author: "Benjamin Holding"
date: 'Last Updated: `r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE)
```

```{r packages, include=FALSE}
ipak <- function(pkg){
    new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
    if (length(new.pkg)) 
        install.packages(new.pkg, dependencies = TRUE)
    sapply(pkg, require, character.only = TRUE)
} #function to see if package is installed. Will download if not, and then opens it.

packages <- c("data.table", "lubridate", "anytime", "dplyr", "ggplot2", "nlme", "tidyr", "lme4", "lmerTest", "sjPlot") #These are the extra packages needed to merge the CSV files
suppressPackageStartupMessages(ipak(packages))
```

```{r data, include=FALSE}

myoriginalwd <- getwd()
setwd("Stroop") #enter the location of the data here between quotation marks
file_list <- list.files()
L <- length(file_list) 

Stroop_list <- lapply(file_list, read.csv, header=T, sep=",", dec=".")

setwd(myoriginalwd)
Stroop.names <- read.csv("Stroop_filenames.csv", header = F)

names(Stroop_list) <- Stroop.names[,1]

final.list <- mapply(cbind, Stroop_list, "SampleID"=Stroop.names[,1], SIMPLIFY=F)

WakeApp_Stroop <- rbindlist(final.list, fill = T) #this is the complete data frame
WakeApp_Stroop$id <- as.character(WakeApp_Stroop$id)
WakeApp_Stroop$id[which(WakeApp_Stroop$id == "SI_106_2")] <- "SI_106"
WakeApp_Stroop$id[which(WakeApp_Stroop$id == "SI_106_3")] <- "SI_106"
WakeApp_Stroop$id[which(WakeApp_Stroop$id == "SI_106_4")] <- "SI_106"

WakeApp_Stroop$id <- as.numeric(gsub("[^0-9]","",WakeApp_Stroop$id))
colnames(WakeApp_Stroop)[1] <- "ID"

slesi.key <- read.csv("SleSI_Masterkey.csv")

WakeApp_Stroop_complete <- inner_join(WakeApp_Stroop, slesi.key)

WakeApp_Stroop_complete$SampleID <- gsub("STROOP_", "", WakeApp_Stroop_complete$SampleID)
WakeApp_Stroop_complete$SampleID <- gsub(".csv", "", WakeApp_Stroop_complete$SampleID)
sample_n(WakeApp_Stroop_complete[,c(1,18,15)], 10) #check that everything is matched correctely

Stroop_Complete_TIDY <- WakeApp_Stroop_complete[c(-1,-2,-3)] %>% 
  separate(SampleID, into = c("ID", "time"), sep = "\\_")
                             
Stroop_Complete_TIDY$time <- as.integer(Stroop_Complete_TIDY$time)

```

##remove problem responses
(must respond between 0.1 and 10 seconds)
```{r time}
Stroop_Complete_TIDY <- Stroop_Complete_TIDY[which(Stroop_Complete_TIDY$reaction_time > 100 & Stroop_Complete_TIDY$reaction_time < 10000),]

#removing congruence catagories that are NA
Stroop_Complete_TIDY <- Stroop_Complete_TIDY[which(Stroop_Complete_TIDY$stimuli_combination != "NA"),]
```

# Stroop correct responses
###Finding the best growth curve model
```{r growth curve all}
# assessing the best random effects
model.1a <- glmer(correct~1 + (1|ID), data=Stroop_Complete_TIDY, family=binomial)
model.1b <- glmer(correct~1 + (1|ID) + (1|order_in_test), data=Stroop_Complete_TIDY, family=binomial) 
model.1c <- glmer(correct~1 + (1|ID) + (1|order_in_test) + (1|order_of_test), data=Stroop_Complete_TIDY, family=binomial) #best

anova(model.1a, model.1b, model.1c)

# assessing the best time polynomial
model.3a<- glmer(correct~1 + (1|ID) + (1|order_in_test) + (1|order_of_test), data=Stroop_Complete_TIDY, family=binomial)
model.3b<- glmer(correct~time + (1|ID) + (1|order_in_test) + (1|order_of_test), data=Stroop_Complete_TIDY, family=binomial)
model.3c<- glmer(correct~time + I(time^2) + (1|ID) + (1|order_in_test) + (1|order_of_test), data=Stroop_Complete_TIDY, family=binomial)
model.3d<- glmer(correct~time + I(time^2) + I(time^3)+ (1|ID) + (1|order_in_test) + (1|order_of_test), data=Stroop_Complete_TIDY, family=binomial) #best

anova(model.3a, model.3b, model.3c,model.3d)

#adding in sleep condition

model.6a<- glmer(correct~time + I(time^2) + I(time^3)+ (1|ID) + (1|order_in_test) + (1|order_of_test), data=Stroop_Complete_TIDY, family=binomial)
model.6b<- glmer(correct~SD + time + I(time^2) + I(time^3)+ (1|ID) + (1|order_in_test) + (1|order_of_test), data=Stroop_Complete_TIDY, family=binomial)
model.6c <- glmer(correct~SD*time + I(time^2) + I(time^3)+ (1|ID) + (1|order_in_test) + (1|order_of_test), data=Stroop_Complete_TIDY, family=binomial)
model.6d <- glmer(correct~SD*time + SD*I(time^2) + I(time^3)+ (1|ID) + (1|order_in_test) + (1|order_of_test), data=Stroop_Complete_TIDY, family=binomial) #best
model.6e <- glmer(correct~SD*time + SD*I(time^2) + SD*I(time^3) + (1|ID) + (1|order_in_test) + (1|order_of_test), data=Stroop_Complete_TIDY, family=binomial)

anova(model.6a,model.6b, model.6c,model.6d,model.6e)

# how does congruence fit in

model.5a <- glmer(correct~SD*time + SD*I(time^2) + I(time^3)+ (1|ID) + (1|order_in_test) + (1|order_of_test), data=Stroop_Complete_TIDY, family=binomial)
model.5b <- glmer(correct~stimuli_combination + SD*time + SD*I(time^2) + I(time^3)+ (1|ID) + (1|order_in_test) + (1|order_of_test), data=Stroop_Complete_TIDY, family=binomial) #best
model.5c <- glmer(correct~stimuli_combination*SD*time + SD*I(time^2) + I(time^3)+ (1|ID) + (1|order_in_test) + (1|order_of_test), data=Stroop_Complete_TIDY, family=binomial)
model.5d <- glmer(correct~stimuli_combination*SD*time + stimuli_combination*SD*I(time^2) + I(time^3)+ (1|ID) + (1|order_in_test) + (1|order_of_test), data=Stroop_Complete_TIDY, family=binomial)
model.5e <- glmer(correct~stimuli_combination*SD*time + stimuli_combination*SD*I(time^2) + stimuli_combination*I(time^3)+ (1|ID) + (1|order_in_test) + (1|order_of_test), data=Stroop_Complete_TIDY, family=binomial)

anova(model.5a,model.5b,model.5c,model.5d, model.5e)

```

###Best model for correct Stroop responses
predicts score from congruency, time, time2, time3, SD, congruency:time, congruency:SD, SD:time2
```{r}
#best model
summary(model.5b)
```


###plotting the raw data and final model
```{r}
Stroop_Complete_TIDY$SD <- factor(Stroop_Complete_TIDY$SD, labels = c("Control", "Sleep Deprivation"))
Stroop_Complete_TIDY$stimuli_combination <- factor(Stroop_Complete_TIDY$stimuli_combination, labels = c("Congruent -> Congruent","Congruent -> Incongruent","Incongruent -> Congruent","Incongruent -> Incongruent"))


Stroop.final.model <- model.5b

ggplot(Stroop_Complete_TIDY, aes(time, correct, colour=SD)) + 
  stat_summary(fun.data=mean_cl_normal, fun.args=list(conf.int=0.95), geom="pointrange")  + 
  labs(y="correct", x="Time point") + 
  facet_wrap( ~ stimuli_combination) +
  ggtitle("Stroop raw data plot (accuracy) with 95% confidence intervals") +
  theme_bw() + scale_color_manual(values=c("red", "blue")) + stat_summary(fun.y=mean, geom="line") 

ggplot(data = Stroop_Complete_TIDY,  aes(time, correct, colour=SD)) + 
  stat_summary(fun.data = mean_cl_normal, geom = "errorbar", width =0.1) +
  stat_summary(fun.y=mean, geom="point")  +
  stat_summary(fun.y=mean, geom="line")  +
  stat_summary(fun.y = mean,geom = "point", size=4, aes(shape=SD,fill=SD)) + 
     scale_x_continuous("Time", breaks=0:3, labels = c("22:00", "09:00", "12:30", "16:00")) +
     scale_y_continuous("Percentage correct") +
     scale_shape_manual(values=c(24,21)) +
     scale_fill_manual(values=c("white","black")) +
  scale_color_manual(values=c('black','black')) + 
     theme_apa() +
  theme(axis.title = element_text(face = "bold"),
        panel.border = element_blank(),
        axis.line = element_line(color = 'black'))+ 
  facet_wrap( ~ stimuli_combination)

ggplot(model.6d, aes(time, correct, colour=SD)) + 
  labs(y="Stroop (correct score)", x="Time point") +
    ggtitle("Stroop fitted model data plot (accuracy)") +
  theme_bw() + stat_summary(aes(y=fitted(Stroop.final.model)), fun.data=mean_cl_normal, fun.args=list(conf.int=0.95), geom="pointrange") + stat_smooth(method = "lm", formula  =y ~ poly(x,3)) 

plot_model(Stroop.final.model, type = "pred", terms = c("time", "SD", "stimuli_combination"))

```

#Stroop reaction time (for correct responses)
###Finding best growth curve model
```{r}
Stroop_complete_correct <- Stroop_Complete_TIDY[which(Stroop_Complete_TIDY$correct == 1),]

# assessing the best random effects
model.1a <- lmer(reaction_time~1 + (1|ID), data=Stroop_complete_correct, REML =F)
model.1b <- lmer(reaction_time~1 + (1|ID) + (1|order_in_test), data=Stroop_complete_correct, REML =F) 
model.1c <- lmer(reaction_time~1 + (1|ID) + (1|order_in_test) + (1|order_of_test), data=Stroop_complete_correct, REML =F) #best

anova(model.1a, model.1b, model.1c)

# assessing the best time polynomial
model.3a <- lmer(reaction_time~1 + (1|ID) + (1|order_in_test) + (1|order_of_test), data=Stroop_complete_correct, REML =F)
model.3b<- lmer(reaction_time~time + (1|ID) + (1|order_in_test) + (1|order_of_test), data=Stroop_complete_correct, REML =F)
model.3c<- lmer(reaction_time~time + I(time^2) + (1|ID) + (1|order_in_test) + (1|order_of_test), data=Stroop_complete_correct, REML =F)
model.3d<- lmer(reaction_time~time + I(time^2) + I(time^3) + (1|ID) + (1|order_in_test) + (1|order_of_test), data=Stroop_complete_correct, REML =F) #best

anova(model.3a, model.3b, model.3c, model.3d) 


#adding sleep condition
model.6a<-lmer(reaction_time~time + I(time^2) + I(time^3) + (1|ID) + (1|order_in_test) + (1|order_of_test), data=Stroop_complete_correct, REML =F)
model.6b<-lmer(reaction_time~SD +time + I(time^2) + I(time^3) + (1|ID) + (1|order_in_test) + (1|order_of_test), data=Stroop_complete_correct, REML =F)
model.6c<-lmer(reaction_time~SD*time + I(time^2) + I(time^3) + (1|ID) + (1|order_in_test) + (1|order_of_test), data=Stroop_complete_correct, REML =F)
model.6d<-lmer(reaction_time~SD*time + SD*I(time^2) + I(time^3) + (1|ID) + (1|order_in_test) + (1|order_of_test), data=Stroop_complete_correct, REML =F)
model.6e<- lmer(reaction_time~SD*time + SD*I(time^2) + SD*I(time^3) + (1|ID) + (1|order_in_test) + (1|order_of_test), data=Stroop_complete_correct, REML =F) #best
anova(model.6a,model.6b,model.6d,model.6e)

#Adding congruence
model.5a<-lmer(reaction_time~SD*time + SD*I(time^2) + SD*I(time^3) + (1|ID) + (1|order_in_test) + (1|order_of_test), data=Stroop_complete_correct, REML =F)
model.5b<-lmer(reaction_time~stimuli_combination +SD*time + SD*I(time^2) + SD*I(time^3) + (1|ID) + (1|order_in_test) + (1|order_of_test), data=Stroop_complete_correct, REML =F) #best
model.5c<-lmer(reaction_time~stimuli_combination*SD*time + SD*I(time^2) + SD*I(time^3) + (1|ID) + (1|order_in_test) + (1|order_of_test), data=Stroop_complete_correct, REML =F)
model.5d<-lmer(reaction_time~stimuli_combination*SD*time + stimuli_combination*SD*I(time^2) + SD*I(time^3) + (1|ID) + (1|order_in_test) + (1|order_of_test), data=Stroop_complete_correct, REML =F)
model.5e<-lmer(reaction_time~stimuli_combination*SD*time + stimuli_combination*SD*I(time^2) + stimuli_combination*SD*I(time^3) + (1|ID) + (1|order_in_test) + (1|order_of_test), data=Stroop_complete_correct, REML =F)

anova(model.5a,model.5b, model.5c, model.5d, model.5e) 

```

###best model (correct answers only)
```{r}
summary(model.5b)
```

### plotting raw data and model
```{r}

StroopRT.final.model <- model.5b

ggplot(Stroop_complete_correct, aes(time, reaction_time, colour=SD)) + 
  stat_summary(fun.data=mean_cl_normal, fun.args=list(conf.int=0.95), geom="pointrange")  + 
  labs(y="correct", x="Time point") +
  theme_bw() + scale_color_manual(values=c("red", "blue")) + stat_summary(fun.y=mean, geom="line") + 
  facet_wrap( ~ stimuli_combination)

ggplot(data = Stroop_complete_correct,  aes(time, reaction_time, colour=SD)) + 
  stat_summary(fun.data = mean_cl_normal, geom = "errorbar", width =0.1) +
  stat_summary(fun.y=mean, geom="point")  +
  stat_summary(fun.y=mean, geom="line")  +
  stat_summary(fun.y = mean,geom = "point", size=4, aes(shape=SD,fill=SD)) + 
     scale_x_continuous("Time", breaks=0:3, labels = c("22:00", "09:00", "12:30", "16:00")) +
     scale_y_continuous("Answer time (ms)") +
     scale_shape_manual(values=c(24,21)) +
     scale_fill_manual(values=c("white","black")) +
  scale_color_manual(values=c('black','black')) + 
     theme_apa() +
  theme(axis.title = element_text(face = "bold"),
        panel.border = element_blank(),
        axis.line = element_line(color = 'black'))+ 
  facet_wrap( ~ stimuli_combination)

ggplot(Stroop_complete_correct, aes(time, reaction_time, colour=SD)) + 
  labs(y="Stroop (correct score)", x="Time point") +
  theme_bw() +
  stat_summary(aes(y=fitted(StroopRT.final.model)), fun.data=mean_cl_normal, fun.args=list(conf.int=0.95),
                            geom="pointrange") + geom_smooth(method = "lm", formula  =y ~ poly(x,3))

plot_model(StroopRT.final.model, type = "pred", terms = c("time", "SD", "stimuli_combination"))
```
